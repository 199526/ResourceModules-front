name: 'AnalysisServices - Servers'

parameters:
  - name: removeDeployment
    displayName: Remove deployed module
    type: boolean
    default: true
  - name: prerelease
    displayName: Publish prerelease module
    type: boolean
    default: false

trigger:
  batch: true
  branches:
    include:
      - main
  paths:
    include:
      - '/.azuredevops/modulePipelines/ms.analysisservices.servers.yml'
      - '/.azuredevops/pipelineTemplates/module.*.yml'
      - '/arm/Microsoft.AnalysisServices/servers/*'
    exclude:
      - '/**/*.md'

variables:
  - template: '/.azuredevops/pipelineVariables/global.variables.yml'
  - group: 'PLATFORM_VARIABLES'
  - name: modulePath
    value: '/arm/Microsoft.AnalysisServices/servers'

stages:
  - stage: Validation
    displayName: Pester tests
    jobs:
      - template: /.azuredevops/pipelineTemplates/jobs.validateModulePester.yml

  - stage: DependencyDeployment
    displayName: Dependency Deployment
    jobs:
      - template: /.azuredevops/pipelineTemplates/jobs.deployTemplate.yml
        parameters:
          templatePath: '$(modulePath)/.dependencies/dependencies.bicep'

  - stage: Deployment
    displayName: Deployment tests
    jobs:
      - job: deploy # name of the job, A-Z, a-z, 0-9, and underscore
        displayName: Deploy
        strategy:
          parallel: # parallel strategy
          matrix: ['min.parameters.json'] # , 'parameters.json', 'max.parameters.json']
        steps:
          - template: /.azuredevops/pipelineTemplates/steps.deployTemplate.yml
            parameters:
              parameterFilePath: ''
          - template: /.azuredevops/pipelineTemplates/steps.removeTemplateDeployment.yml
            parameters:
              parameterFilePath: ''

      # - template: /.azuredevops/pipelineTemplates/jobs.deployTemplate.yml
      #   parameters:
      #     removeDeployment: '${{ parameters.removeDeployment }}'
      #     templatePath: '$(modulePath)/deploy.bicep'
      #     deploymentBlocks: # TODO: Transform to Job-Level matrix?
      #       - path: $(modulePath)/.parameters/min.parameters.json
      #       - path: $(modulePath)/.parameters/parameters.json
      #       - path: $(modulePath)/.parameters/max.parameters.json

      - template: /.azuredevops/pipelineTemplates/jobs.removeTemplateDeployment
        condition: and(succeededOrFailed(), eq( '${{ parameters.removeDeployment }}', 'true'), not(eq(variables['deploymentName'],'')))
        parameters:
          templatePath: '$(modulePath)/.dependencies/dependencies.bicep'
          deploymentName: ''

  - stage: Publishing
    displayName: Publish module
    condition: and(succeeded(), or(eq(variables['Build.SourceBranch'], 'refs/heads/main'), eq(variables['Build.SourceBranch'], 'refs/heads/master'), eq('${{ parameters.prerelease }}', 'true')))
    jobs:
      - template: /.azuredevops/pipelineTemplates/jobs.publishModule.yml
